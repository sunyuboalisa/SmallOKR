name: SmallOKR Server CI/CD
run-name: ${{ github.actor }} build and push docker images

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write # âœ… æ”¯æŒ OIDCï¼ˆæœªæ¥æ›´å®‰å…¨çš„è®¤è¯æ–¹å¼ï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Build Spring Cloud project
        working-directory: ./smallokr_server
        run: ./mvnw clean package -DskipTests

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push service images
        working-directory: ./smallokr_server
        env:
          IMAGE_BASE: ghcr.io/${{ github.repository_owner }}/smallokr
        run: |
          services=(gateway targetservice todoservice traceservice userservice)
          for service in "${services[@]}"; do
            echo "ğŸš€ Building $service ..."
            docker build -t $IMAGE_BASE-$service:latest -f ./docker/$service.Dockerfile .
            docker push $IMAGE_BASE-$service:latest
          done

      - name: Deploy on Cloud Server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -p "$SSH_PORT" -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'EOF'
            set -e
            cd ~/smallokr/
            echo "ğŸ§° Pulling latest images..."
            docker compose pull
            echo "ğŸ§¹ Restarting containers..."
            docker compose down
            docker compose up -d
          EOF
